@import plugins.Context
@import de.fuberlin.wiwiss.silk.workspace.{User, Workspace, Project}
@import de.fuberlin.wiwiss.silk.workspace.modules.Task
@import de.fuberlin.wiwiss.silk.runtime.activity.ActivityControl
@import controllers.workspace.routes.WorkspaceApi
@import controllers.workspace.routes.Assets

@()

@header = {
  <link rel="stylesheet" href="@Assets.at("libs/jstree/style.min.css")" type="text/css" />
  <link rel="stylesheet" href="@Assets.at("workspace.css")" type="text/css" />
  <script src="@Assets.at("libs/jstree/jstree.min.js")" type="text/javascript"></script>
  <script src="@Assets.at("workspace.js")" type="text/javascript"></script>
  <script type="text/javascript">
    $(function () {
      @for(project <- User().workspace.projects;
           task <- project.allTasks;
           activity <- task.activities) {
        updateStatus({
          "project": "@project.name",
          "task": "@task.name",
          "activity": "@activity.name",
          "progress": @{activity.status().progress * 100.0},
          "message": "@activity.status().toString",
          "failed": @activity.status().failed,
        });
      }

      $('#workspace_root').jstree();
    });

    function updateStatus(status) {
      function select(suffix) {
        var id = "progress_" + status.project + "_" + status.task + "_" + encodeURIComponent(status.activity).replace(/%20/g,'+') + suffix;
        return $(document.getElementById(id))
      }

      if(status.failed) {
        select("").progressbar({
          value: 0
        });
        select("-text").html("Failed ");
        select("-help").show();
        select("").attr('title', status.message);
      } else {
        select("").attr('title', status.message);
        select("").progressbar({
          value: parseFloat(status.progress)
        });
        //select("-help").hide();
        select("-text").html(status.message);
      }
    }

    function post(url) {
      $.get(url).fail(function(request) { alert(request.responseText); })
    }
  </script>
}

@toolbar = {
}

@content = {
  @workspaceActivities(User().workspace)

  <iframe src="@WorkspaceApi.activityUpdates("", "", "").url" style="display:none" frameborder="0" height="0" width="0"></iframe>
}

@workspaceActivities(workspace: Workspace) = {
  <div id="workspace_root">
    <ul class="filetree">
    @for(project <- workspace.projects) {
      @projectActivities(project)
    }
    </ul>
  </div>
}

@projectActivities(project: Project) = {
  <li id="project_@project.name" class="jstree-open" >
    @project.name
    <ul>
    @for(task <- project.allTasks) {
      @taskActivities(project, task)
    }
    </ul>
  </li>
}

@taskActivities(project: Project, task: Task[_]) = {
  <li id="task_@{project.name}_@task.name" class="jstree-open">
    @task.name
    <ul>
    @for(activity <- task.activities) {
      @activityStatus(id(project.name, task.name, activity.name), project, task, activity)
    }
    </ul>
  </li>
}

@activityStatus(id: String, project: Project, task: Task[_], activity: ActivityControl[_]) = {
  <li data-jstree='{"icon":"@Assets.at("img/file-tag.png")"}'>
    @activity.name
    <div id="@id" class="activity-progress-small">
      <div id="@id-text" class="activity-progress-small-text"></div>
      @*<img id="@id-help" src="@Assets.at("img/help.png")"/>*@
    </div>
    <button class="activity-button" onclick="post('@WorkspaceApi.startActivity(project.name, task.name, activity.name).url')">Start</button>
  </li>
}

@id(project: String, task: String, activity: String) = @{
  "progress_" + project + "_" + task + "_" + helper.urlEncode(activity)
}

@main(None, "status")(header)(toolbar)(content)