@import org.silkframework.entity.ForwardOperator
@import plugins.Context
@import org.silkframework.rule.TransformRule
@import org.silkframework.rule.input.PathInput
@import org.silkframework.entity.Path
@import org.silkframework.workspace.activity.transform.TransformPathsCache
@import controllers.rules.routes.Assets
@import org.silkframework.config.TransformSpec
@import org.silkframework.rule.{DirectMapping, ObjectMapping, TypeMapping, UriMapping}
@import org.silkframework.rule.ComplexMapping
@import org.silkframework.runtime.serialization.XmlSerialization

@(context: Context[TransformSpec])

@header = {
  <link type="text/css" href="@Assets.at("stylesheets/editor/transformRules.css")" rel="stylesheet" />
  <link type="text/css" href="@Assets.at("stylesheets/editor/status.css")" rel="stylesheet" />

  <script type="text/javascript" src="@Assets.at("js/editor/transformRules.js")"></script>
  <script type="text/javascript" src="@Assets.at("js/editor/status.js")"></script>
  <script type="text/javascript">
    var apiUrl = '@config.baseUrl/transform/tasks/@context.project.name/@context.task.id';
  </script>
}

@toolbar = {
  <ul>
    <li>
      <button class="mdl-button mdl-js-button mdl-button--raised" onclick="addRule('#uriMappingTemplate')">Add URI Mapping</button>
    </li>
    <li>
      <button class="mdl-button mdl-js-button mdl-button--raised" onclick="addRule('#typeMappingTemplate')">Add Type Mapping</button>
    </li>
    <li>
      <button class="mdl-button mdl-js-button mdl-button--raised" onclick="addRule('#directMappingTemplate')">Add Direct Mapping</button>
    </li>
    <li>
      <button class="mdl-button mdl-js-button mdl-button--raised" onclick="addRule('#objectMappingTemplate')">Add Object Mapping</button>
    </li>
    <li>
      @* widgets.taskActivityControl(context, context.task.activity[PathsCache].name) *@
    </li>
  </ul>

  @status()
}

@content = {
  <div id="ruleContainer">

    @for(rule <- context.task.data.rules) {
      @renderRule(rule)
    }
  </div>

  <div id="uriMappingTemplate" style="display: none">
    @renderRule(UriMapping())
  </div>

  <div id="typeMappingTemplate" style="display: none">
    @renderRule(TypeMapping())
  </div>

  <div id="directMappingTemplate" style="display: none">
  @renderRule(DirectMapping())
  </div>

  <div id="objectMappingTemplate" style="display: none">
  @renderRule(ObjectMapping())
  </div>

  <div id="dialogDelete" title="Confirm">
    <p>
      <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
      Delete transformation rule?
    </p>
  </div>
}

@renderRule(rule: TransformRule) = {
<div class="mdl-card @{rule.typeString.toLowerCase}Mapping mdl-shadow--2dp">
  <div class="mdl-card__title ruleTitle">
    <div class="rule-name">@rule.name</div>&nbsp;
    <div class="rule-type">(@rule.typeString Mapping)</div>
  </div>
  <div class="mdl-card__supporting-text">
    <form action="#">
    @{ rule match {
      case r: DirectMapping => renderDirectRule(r)
      case r: UriMapping => renderUriRule(r)
      case r: ObjectMapping => renderObjectRule(r)
      case r: TypeMapping => renderTypeRule(r)
      case r: ComplexMapping => renderComplexRule(r)
    }}
    </form>
  </div>
  <div class="mdl-card__actions">
    @renderRuleButtons()
  </div>
  <script class="ruleXML" type="application/xml">
    @XmlSerialization.toXml[TransformRule](rule)
  </script>
</div>
}

@renderDirectRule(rule: DirectMapping) = {
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-source" value="@rule.sourcePath.serializeSimplified(prefixes())">
    <label class="mdl-textfield__label" for="@{rule.name}-source">Source Path</label>
  </div>
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-target" value="@rule.targetProperty.serialize(prefixes())">
    <label class="mdl-textfield__label" for="@{rule.name}-target">Target Path</label>
  </div>
}

@renderUriRule(rule: UriMapping) = {
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-pattern" value="@rule.pattern">
    <label class="mdl-textfield__label" for="@{rule.name}-pattern">Pattern</label>
  </div>
}

@renderObjectRule(rule: ObjectMapping) = {
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-pattern" value="@rule.pattern">
    <label class="mdl-textfield__label" for="@{rule.name}-pattern">Pattern</label>
  </div>
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-target" value="@rule.targetProperty.serialize(prefixes())">
    <label class="mdl-textfield__label" for="@{rule.name}-target">Target</label>
  </div>
}

@renderTypeRule(rule: TypeMapping) = {
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-type" value="@rule.typeUri.serialize(context.project.config.prefixes)">
    <label class="mdl-textfield__label" for="@{rule.name}-type">Type</label>
  </div>
}

@renderComplexRule(rule: ComplexMapping) = {
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-source" value="@renderRulePath(rule)" disabled>
    <label class="mdl-textfield__label" for="@{rule.name}-source">Source Path</label>
  </div>
  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="@{rule.name}-target" value="@rule.target.map(_.serialize(prefixes())).getOrElse("")">
    <label class="mdl-textfield__label" for="@{rule.name}-target">Target Property</label>
  </div>
}

@renderRuleButtons() = {
  <button class="mdl-button mdl-js-button mdl-button--icon" onclick="openRule($(this).parent().parent().find('.name').val())">
    <i class="material-icons">build</i>
  </button>
  <button class="mdl-button mdl-js-button mdl-button--icon" onclick="deleteRule($(this).parent().parent())">
    <i class="material-icons">delete</i>
  </button>
}

@renderRulePath(rule: ComplexMapping) = {@if(rule.paths.size == 1) {@rule.paths.head.serializeSimplified(prefixes())} else {(multiple)}}

@prefixes() = @{ context.project.config.prefixes }

@main(Some(context))(header)(toolbar)(content)